@{ ViewBag.Title = "Mi Historial"; Layout = "/Views/Shared/_Layout.cshtml"; }
<div class="p-4">
    <h3>Mi Historial Académico</h3>
    <div id="chartContainer">
        <canvas id="miHistorialChart" width="800" height="400"></canvas>
    </div>
    <div class="mt-3">
        <label>Desde: <input type="date" id="desde" /></label>
        <label class="ms-2">Hasta: <input type="date" id="hasta" /></label>
        <button id="btnFiltrar" class="btn btn-primary btn-sm ms-2">Filtrar</button>
    </div>
</div>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function () {
            const ctx = document.getElementById('miHistorialChart').getContext('2d');
            let chart = null;
            async function cargar(desde, hasta) {
                let url = '/api/historial/mio';
                const qs = [];
                if (desde) qs.push('from=' + encodeURIComponent(desde));
                if (hasta) qs.push('to=' + encodeURIComponent(hasta));
                if (qs.length) url += '/filtrado?' + qs.join('&');
                const r = await fetch(url, { credentials: 'include' });
                if (!r.ok) { console.error('Error', r.status); return; }
                const json = await r.json();
                // json.Cuatrimestres -> [{ Cuatrimestre: "2024-1", Cursos: [{ Curso, Nota, Fecha }], Promedio }]
                const labels = [];
                const data = [];
                (json.cuatrimestres || []).forEach(c => {
                    labels.push(c.cuatrimestre || c.Cuatrimestre || '');
                    data.push(c.promedio ?? 0);
                });
                if (chart) chart.destroy();
                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{ label: 'Promedio por cuatrimestre', data: data, backgroundColor: 'rgba(54,162,235,0.5)' }]
                    }
                });
            }
            document.getElementById('btnFiltrar').addEventListener('click', () => {
                const desde = document.getElementById('desde').value;
                const hasta = document.getElementById('hasta').value;
                cargar(desde, hasta);
            });
            // carga inicial
            cargar();
        })();
    </script>
}
