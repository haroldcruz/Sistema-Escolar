@{
    ViewBag.Title = "Cursos";
    Layout = "/Views/Shared/_Layout.cshtml";
}
<h2>Cursos</h2>
<div class="mb-3 d-flex gap-2">
    <a class="btn btn-primary" href="/Cursos/Crear">Nuevo Curso</a>
</div>
<table class="table" id="tablaCursos">
    <thead>
        <tr>
            <th>Código</th>
            <th>Nombre</th>
            <th>Créditos</th>
            <th>Cuatrimestre</th>
            <th>Docentes</th>
            <th style="width:240px">Acciones</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
<script>
    // small HTML escape helper to avoid inserting raw content
    function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]); }); }

    async function cargar(){
        const r = await fetch('/api/cursos', { credentials:'include' });
        if(!r.ok){ alert('Error al cargar cursos'); return; }
        const data = await r.json();
        const tbody = document.querySelector('#tablaCursos tbody');
        tbody.innerHTML = '';
        data.forEach(c => {
            // provide safe fallbacks for possibly missing fields
            const codigo = c.codigo ?? '';
            // If the API returned 'nombre' that already contains the code prefix like "C002 - Nombre",
            // remove the prefix to avoid duplicate display (we show codigo separately)
            let nombreDisplay = c.nombre ?? '';
            if (nombreDisplay && codigo && nombreDisplay.startsWith(codigo + ' - ')){
                nombreDisplay = nombreDisplay.substring((codigo + ' - ').length);
            }
            const creditos = (c.creditos === null || c.creditos === undefined) ? '' : c.creditos;
            const cuatrimestre = c.cuatrimestre ?? '';
            const docentes = (c.docentes || []).join(', ');

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${escapeHtml(codigo)}</td>
                <td>${escapeHtml(nombreDisplay)}</td>
                <td>${escapeHtml(creditos)}</td>
                <td>${escapeHtml(cuatrimestre)}</td>
                <td>${escapeHtml(docentes)}</td>
                <td>
                    <a class="btn btn-sm btn-outline-secondary" href="/Cursos/Editar/${c.id}">Editar</a>
                    <a class="btn btn-sm btn-outline-info" href="/Cursos/AsignarDocentes/${c.id}">Docentes</a>
                    <button class="btn btn-sm btn-outline-danger" data-id="${c.id}">Eliminar</button>
                </td>`;
            tbody.appendChild(tr);
        });
        tbody.querySelectorAll('button[data-id]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const id = e.currentTarget.getAttribute('data-id');
                if(!confirm('¿Eliminar curso?')) return;
                const del = await fetch('/api/cursos/'+id, { method:'DELETE', credentials:'include' });
                if(del.status===409){ const j = await del.json().catch(()=>({message:'Estudiantes matriculados'})); alert(j.message||'Estudiantes matriculados'); return; }
                if(del.ok) cargar(); else alert('No se pudo eliminar');
            });
        });
    }
    cargar();
</script>
