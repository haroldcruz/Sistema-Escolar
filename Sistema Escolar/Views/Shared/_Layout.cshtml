@* Layout con visibilidad por permisos granular y separación de módulos *@
<!DOCTYPE html>
<html lang="es">
<head>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <title>@(ViewBag.Title ?? "Inicio") - Sistema Escolar</title>
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
@{
 var roles = string.Join(',', User?.Claims.Where(c=>c.Type==System.Security.Claims.ClaimTypes.Role).Select(c=>c.Value) ?? new string[0]);
 // Use null-conditional on User to avoid possible NullReferenceException when User is null
 var userId = User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
 // Toast message from TempData or ViewBag
 var toastMsg = (TempData["ToastMessage"] as string) ?? (ViewBag.ToastMessage as string) ?? string.Empty;
 var toastType = (TempData["ToastType"] as string) ?? (ViewBag.ToastType as string) ?? "info";
}
<body data-user-id="@userId" data-user-role="@roles">
 <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
 <div class="container-fluid">
 <a class="navbar-brand" href="/">Sistema Escolar</a>
 <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
 <span class="navbar-toggler-icon"></span>
 </button>
 <div class="collapse navbar-collapse" id="nav">
 <ul class="navbar-nav me-auto mb-2 mb-lg-0">
 @if (User?.Identity?.IsAuthenticated ?? false)
 {
 // Show Cursos if user has permiso or is Administrator
 if (User.HasClaim("permiso","Cursos.Ver") || User.IsInRole("Administrador")) { <li class="nav-item"><a class="nav-link" asp-controller="Cursos" asp-action="Index">Cursos</a></li> }
 // Módulo separado para asignar docentes (no reutiliza listado de cursos)
 if (User.HasClaim("permiso","Cursos.AsignarDocente") || User.IsInRole("Administrador")) { <li class="nav-item"><a class="nav-link" href="/Docentes">Asignar Docentes</a></li> }
 // Usuarios: permitir ver si tiene permiso o es Administrador
 if (User.HasClaim("permiso","Usuarios.Gestion") || User.IsInRole("Administrador")) { <li class="nav-item"><a class="nav-link" href="/Usuarios">Usuarios</a></li> }
 // Roles / Seguridad: mostrar si tiene el permiso de seguridad o es Administrador
 if (User.HasClaim("permiso","Seguridad.Gestion") || User.IsInRole("Administrador")) { <li class="nav-item"><a class="nav-link" href="/Seguridad/Roles">Roles</a></li> }
 // Bitácora: mostrar si tiene permiso o es Administrador
 if (User.HasClaim("permiso","Bitacora.Ver") || User.IsInRole("Administrador")) { <li class="nav-item"><a class="nav-link" href="/Bitacora">Bitácora</a></li> }
 // Enlace al módulo Evaluaciones visible sólo si el usuario tiene el permiso Evaluaciones.Crear or is Admin
 if (User.HasClaim("permiso","Evaluaciones.Crear") || User.IsInRole("Administrador")) { <li class="nav-item"><a class="nav-link" href="/Evaluaciones">Evaluaciones</a></li> }
 // Links relevantes para Docente
 if (User.IsInRole("Docente")) {
 <li class="nav-item"><a class="nav-link" href="/Cursos">Mis Cursos</a></li>
 <li class="nav-item"><a class="nav-link" href="/Historial">Historial</a></li>
 <li class="nav-item"><a class="nav-link" href="/Historial/BuscarEvaluacion">Buscar y Evaluar</a></li>
 }
 if (User.IsInRole("Estudiante")) { <li class="nav-item"><a class="nav-link" href="/MiHistorial">Mi Historial</a></li> }
 // Nuevo: enlace a matriculación (solo para admin o permiso Cursos.Crear)
 if (User.HasClaim("permiso","Cursos.Crear") || User.IsInRole("Administrador")) { <li class="nav-item"><a class="nav-link" href="/Matriculas/Crear">Matricular</a></li> }
 // Estadísticas: disponible para Docente y Admin
 if (User.IsInRole("Docente") || User.IsInRole("Administrador")) { <li class="nav-item"><a class="nav-link" href="/Estadisticas">Estadísticas</a></li> }
 // Bloques de evaluación
 if (User.IsInRole("Docente") || User.IsInRole("Administrador")) { <li class="nav-item"><a class="nav-link" href="/Bloques">Bloques</a></li> }
 }
 }
 </ul>
 <ul class="navbar-nav ms-auto">
 @if (User?.Identity?.IsAuthenticated ?? false)
 {
 <li class="nav-item"><span class="navbar-text">@User.Identity!.Name</span></li>
 <li class="nav-item"><a class="nav-link" href="/Auth/Logout">Salir</a></li>
 }
 else
 {
 <li class="nav-item"><a class="nav-link" href="/Auth/Login">Login</a></li>
 }
 </ul>
 </div>
 </div>
 </nav>
 <main class="container">
 @RenderBody()
 </main>

 <!-- Toast container -->
 <div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index:1080;">
 <div id="appToast" class="toast align-items-center text-bg-@toastType border-0" role="alert" aria-live="assertive" aria-atomic="true">
 <div class="d-flex">
 <div class="toast-body">
 @toastMsg
 </div>
 <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
 </div>
 </div>
 </div>

 <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
 <script>if(!window.jQuery){document.write('<script src="/lib/jquery/jquery-3.6.0.min.js"><\\/script>');}</script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
 <script>if(!window.jQuery.validator){document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"><\\/script>');}</script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>
 <script src="/js/site.js"></script>
 <script>
 // Ensure a safe global appShowToast exists even if site.js failed to define it
 if (typeof window.appShowToast !== 'function') {
 window.appShowToast = function(message, type){
 try{
 const toastEl = document.getElementById('appToast');
 if(!toastEl) { alert(message); return; }
 const body = toastEl.querySelector('.toast-body');
 if(body) body.textContent = message;
 toastEl.className = toastEl.className.replace(/text-bg-(\w+)/g, '');
 toastEl.classList.add('text-bg-' + (type || 'info'));
 const toast = new bootstrap.Toast(toastEl, { delay:5000 });
 toast.show();
 }catch(e){ alert(message); }
 };
 }

 document.addEventListener('DOMContentLoaded', function(){
 var toastEl = document.getElementById('appToast');
 if (!toastEl) return;
 var msg = '@(toastMsg.Replace("'","\'"))';
 if (!msg) return; // no mostrar si no hay mensaje
 var toast = new bootstrap.Toast(toastEl, { delay:5000 });
 toast.show();
 });
 </script>
 @RenderSection("Scripts", required: false)
</body>
</html>
