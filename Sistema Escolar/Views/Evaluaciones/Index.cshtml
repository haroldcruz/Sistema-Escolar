@{
 ViewBag.Title = "Evaluaciones";
 Layout = "/Views/Shared/_Layout.cshtml";
}
<div class="p-4">
 <h3>Evaluaciones - Buscar Estudiante y Evaluar</h3>
 <div class="row g-3">
 <div class="col-md-6">
 <label>Buscar estudiante</label>
 <input id="txtBuscar" class="form-control" placeholder="Nombre, apellido o identificación" />
 <div id="sugerencias" class="list-group mt-1"></div>
 </div>
 <div class="col-md-6">
 <h5>Detalles del estudiante</h5>
 <div id="detalleEstudiante" class="border rounded p-2">Seleccione un estudiante...</div>
 </div>
 </div>
 <hr />
 <div id="matriculasContainer" class="mt-3"></div>

 <!-- Modal evaluación (reutilizada si se abre desde matrícula) -->
 <div class="modal" tabindex="-1" id="modalEvaluar">
 <div class="modal-dialog">
 <div class="modal-content">
 <div class="modal-header"><h5 class="modal-title">Agregar Evaluación</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
 <div class="modal-body">
 <form id="formEvaluacion">
 <input type="hidden" id="matriculaId" name="MatriculaId" />
 <div class="mb-2"><label>Nota</label><input type="number" step="0.01" min="0" max="100" id="nota" name="Nota" class="form-control" required /></div>
 <div class="mb-2"><label>Participación</label><input type="text" id="participacion" name="Participacion" class="form-control" required /></div>
 <div class="mb-2"><label>Estado</label><select id="estado" name="Estado" class="form-select" required><option value="Aprobado">Aprobado</option><option value="Reprobado">Reprobado</option></select></div>
 <div class="mb-2"><label>Observaciones</label><textarea id="observaciones" name="Observaciones" class="form-control"></textarea></div>
 </form>
 <div id="errorEval" class="text-danger small mt-1"></div>
 </div>
 <div class="modal-footer"><button class="btn btn-primary" id="btnGuardar">Guardar</button><button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button></div>
 </div>
 </div>
 </div>

</div>

@section Scripts{
 <script>
 (function(){
 const txt = document.getElementById('txtBuscar');
 const sugerencias = document.getElementById('sugerencias');
 const detalle = document.getElementById('detalleEstudiante');
 const matriculasContainer = document.getElementById('matriculasContainer');
 const modal = new bootstrap.Modal(document.getElementById('modalEvaluar'));

 let debounceTimer = null;

 txt.addEventListener('input', ()=>{
 clearTimeout(debounceTimer);
 debounceTimer = setTimeout(()=> buscar(txt.value),300);
 });

 async function buscar(term){
 if (!term || term.trim().length <2){ sugerencias.innerHTML = ''; return; }
 try{
 const r = await fetch('/api/estudiantes/buscar?term=' + encodeURIComponent(term), { credentials: 'include' });
 if (!r.ok) { console.error('Error búsqueda', r.status); return; }
 const list = await r.json();
 sugerencias.innerHTML = '';
 list.forEach(s=>{
 const a = document.createElement('a');
 a.className = 'list-group-item list-group-item-action';
 a.href = '#';
 a.textContent = s.nombreCompleto + ' — ' + s.identificacion;
 a.dataset.id = s.id;
 a.addEventListener('click', ev=>{ ev.preventDefault(); seleccionarEstudiante(s); });
 sugerencias.appendChild(a);
 });
 } catch(e){ console.error(e); }
 }

 function seleccionarEstudiante(s){
 sugerencias.innerHTML = '';
 txt.value = s.nombreCompleto;
 detalle.innerHTML = `<strong>${s.nombreCompleto}</strong><br/>ID: ${s.id}<br/>Email: ${s.email}<br/>Identificación: ${s.identificacion}`;
 // cargar matriculas del estudiante en cursos del docente
 cargarMatriculas(s.id);
 }

 async function cargarMatriculas(estudianteId){
 try{
 const r = await fetch(`/api/evaluaciones/estudiante/${estudianteId}/matriculas`, { credentials: 'include' });
 if (!r.ok){ matriculasContainer.innerHTML = '<div class="text-danger">No tiene matrículas en sus cursos o no autorizado.</div>'; return; }
 const list = await r.json();
 if (!list.length){ matriculasContainer.innerHTML = '<div class="text-muted">No hay matrículas en sus cursos.</div>'; return; }
 matriculasContainer.innerHTML = '<h5>Matriculas en mis cursos</h5>' + list.map(m=>`<div class="card mb-2"><div class="card-body"><strong>${m.cursoCodigo} - ${m.cursoNombre}</strong><br/>Cuatrimestre: ${m.cuatrimestre}<br/><button class="btn btn-sm btn-primary mt-2" data-mat="${m.matriculaId}">Evaluar</button></div></div>`).join('');
 // bind botones evaluar
 matriculasContainer.querySelectorAll('button[data-mat]').forEach(b=> b.addEventListener('click', ev=>{ document.getElementById('matriculaId').value = ev.currentTarget.getAttribute('data-mat'); modal.show(); }));
 } catch(e){ console.error(e); }
 }

 // Guardar evaluación
 document.getElementById('btnGuardar').addEventListener('click', async ()=>{
 document.getElementById('errorEval').textContent = '';
 const dto = {
 MatriculaId: parseInt(document.getElementById('matriculaId').value),
 Nota: parseFloat(document.getElementById('nota').value),
 Participacion: document.getElementById('participacion').value,
 Estado: document.getElementById('estado').value,
 Observaciones: document.getElementById('observaciones').value
 };
 // client validation
 if (isNaN(dto.Nota) || dto.Nota <0 || dto.Nota >100){ document.getElementById('errorEval').textContent = 'La nota debe estar entre0 y100'; return; }
 if (!dto.Participacion) { document.getElementById('errorEval').textContent = 'La participación es requerida'; return; }
 try{
 const r = await fetch('/api/evaluaciones', { method: 'POST', credentials: 'include', headers: {'Content-Type':'application/json'}, body: JSON.stringify(dto) });
 if (r.status ===201){ alert('Evaluación creada'); modal.hide(); // refrescar
 const matId = dto.MatriculaId; // find curso id? reload matriculas
 const input = document.getElementById('txtBuscar'); if (input.value) { buscar(input.value); }
 return; }
 if (r.status ===409){ const json = await r.json(); document.getElementById('errorEval').textContent = json.message || 'Ya existe evaluación'; return; }
 if (r.status ===400){ const json = await r.json(); document.getElementById('errorEval').textContent = 'Errores: ' + JSON.stringify(json); return; }
 if (r.status ===403){ document.getElementById('errorEval').textContent = 'No autorizado para evaluar este curso'; return; }
 document.getElementById('errorEval').textContent = 'Error al guardar: ' + r.status;
 } catch(e){ document.getElementById('errorEval').textContent = e.message; }
 });

 })();
 </script>
}
